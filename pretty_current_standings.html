---
layout: default
title: Dominion League Current Season Standings
---

<div class="home">
  <div class="container-centered">

    <h3><a class="current-standings" href="{{site.baseurl}}/current_standings">Season {{ site.data.season.number }} Standings</a></h3>
    <h5><a href="{{site.baseurl}}/past_standings">Past Season Standings</a> â€¢ <a href="{{site.baseurl}}/player_database">Player Database</a></h5>

    <div id="single-division" style="display:none"></div>

    <div id="all-divisions">
      <p> Standings for the current season. Forecasts by markus can be found <a href="https://docs.google.com/spreadsheets/d/1ZgimtlIsDx1B6SRNSxV0NyXeKubQe0KYITUjjaJ-7b8/">here</a>. </p>
      <!-- Filter buttons -->
      <div id="myBtnContainer">
        <button class="btn" onclick="filterSelection('divA')"> A </button>
        {% for tier in site.data.season.tiers %}
        {% if tier.name != "A" %}
        <button class="btn" onclick="filterSelection('div{{tier.name}}')"> {{tier.name}} </button>
        {% endif %}
        {% endfor %}
        <button class="btn" onclick="filterSelection('all')"> Show all</button>
      </div>
      <div class="spacing"></div>
      <div id="divisions"></div>
      <div class="spacing"></div>
    </div>
  </div>
</div>
<script>
// Load data
var divisions = {{ site.data.current_season | jsonify }};
var returning = {{ site.data.current_season_returning | jsonify }};
var tiers = [
  ["A", 1],
  ["B", 2],
  ["C", 4],
  ["D", 4],
  ["E", 8],
  ["F", 14],
  ["G", 13],
  ["H", 25],
  ["I", 25],
  ["J", 26],
  ["P",4]
];
var curr_season = 43;
var champ = "nasmith99";
loadPage();

function formatDbLink(playerName, className, drop="No"){
  var link = `<a class="${className}" href="{{site.baseurl}}/player_database?player=${playerName.replace(/ /g, "%20")}">${playerName}</a>`;
  link = drop == "Yes" ? `<s>${link}</s>` : link;
  return link;
}

function formatShortDbLink(playerName, className, drop="No"){
  var shortend = playerName; //playerName.length <= 4 ? playerName : playerName.substring(0,4).trim() + ".";
  var link = `<a class="${className}" href="{{site.baseurl}}/player_database?player=${playerName.replace(/ /g, "%20")}">${shortend}</a>`;
  link = drop == "Yes" ? `<s>${link}</s>` : link;
  return link;
}


function matchColor(score, upper) {
  var score = parseFloat(score);
  var colors = ["E77B72", "E88372", "EA8C71", "EC956F", "EF9E6E", "F2A76D", "F4B06B", "F7B96B", "F9C269", "FCCB67", "FED467", "F2D467", "E2D26B", "D0CF6F", "C0CC73", "AFCA76", "9EC77A", "8CC47E", "7CC181", "6DBF84", "5BBC88"];
  var normalized = Math.floor((100/101)*colors.length*score/upper);
  var color = colors[normalized];
  return `#${color}`;
}

function matchGreyscaleColor(score, upper){
  var score = parseFloat(score);
  var colors = ["#ffffff", "#f4f4f5", "#eaeaeb", "#dfdfe1", "#d5d5d7", "#cacbcd", "#c0c1c3", "#b6b6ba", "#acacb0", "#a2a3a7", "#98999d", "#8e8f94", "#85868b", "#7b7c82", "#727379"];
  var normalized = Math.floor((100/101)*colors.length*score/upper);
  var color = colors[normalized];
  return color;
}

function standingsColor(cell, tier, next_tier, name){
  if (next_tier == "") {
    return;
  }
  var promotion = "#91eb9b";
  var demotion = "#f0948d";
  if (next_tier < tier || name == champ) {
    cell.style.backgroundColor = promotion;
  } else if (next_tier > tier) {
    cell.style.backgroundColor = demotion;
  }
}

function selectTab(btn, division) {
  var tab = btn.innerHTML;
  var tabToOpen = btn;
  var parent = document.getElementById(`${division}-standings`);
  console.log(`Opening ${division.toUpperCase()}'s ${tab} button`);

  // Open the right table and hide others
  var children = parent.children;
  for (var i = 0; i < children.length; i++) {
    var child = children[i];
    if (child.className == `${tab.toLowerCase()}-table`) {
      child.style.display = "";
    } else if (child.className != 'header-table') {
      child.style.display = "none";
    }
  }

  // Remove active from button siblings
  var curTab = tabToOpen;
  while (curTab = curTab.nextSibling) {
    curTab.classList.remove('active');
  }
  curTab = tabToOpen;
  while (curTab = curTab.previousSibling) {
    curTab.classList.remove('active');
  }
  tabToOpen.classList.add('active');
}

function genHeader(division, complete){
  var table = document.createElement("table");
  table.classList.add('header-table');

  var seasonRow = document.createElement("tr");
  var seasonHeader = document.createElement("td");
  table.appendChild(seasonRow);
  seasonRow.appendChild(seasonHeader);
  var text = complete == "Yes" ? `Division ${division} Standings (complete)` : `Division ${division} Standings`;
  seasonHeader.innerHTML = `<p>${text}</p>`;
  seasonHeader.style.backgroundColor = "lightgrey";
  seasonHeader.setAttribute('colspan', 10);
  seasonHeader.classList.add('division-header');

  var buttons = ["Standings", "Grid", "Matches"];//, "Results"];
  for (var b=0; b < buttons.length; b++){
    var button = document.createElement("button");
    button.innerHTML = buttons[b];
    button.setAttribute("onclick", `selectTab(this, '${division.toLowerCase()}')`);
    if (buttons[b] == "Standings") {
      button.classList.add("active");
    }
    seasonHeader.appendChild(button);
  }
  return table;
}

function genStandings(data, tier, tiebreaker, numDrops, complete) {
  console.log("Generating standings...");
  var table = document.createElement("table");
  table.classList.add('standings-table');

  var sortedRankedMembers = Object.keys(data).map(function(key) {
    return [key, data[key]];
  });
  sortedRankedMembers.sort(function(x, y) {
    return x[1]["rank"] - y[1]["rank"];
  });

  var tableHeadings, headingWidths;

  if (complete == "Yes") {
    tableHeadings = ["#", "Player", "W%", "W", "L", "<img src='img/icons/tier.png'>", "<img src='img/icons/returning.png'>"];
    headingWidths = ["7%", "35%", "14%", "14%", "13%", "8%", "8%"];
  } else {
    tableHeadings = ["#", "Player", "W%", "W", "L", "MP", "<img src='img/icons/returning.png'>"];
    headingWidths = ["7%", "35%", "13%", "12%", "12%", "13%", "8%"];
  }
  var tbValues = {};

  // Figure out tiebreakers
  for (var member in data) {
    for (var opponent in data) {
      memberData = data[member];
      opponentData = data[opponent];
      if (
        member == opponent
        || memberData["drop"] == "Yes"
        || memberData["pct"] == "0%"
        || !(member in tiebreaker)
      ) { continue;}

      if (memberData["pct"] == opponentData["pct"]) {
          if (!(member in tbValues)) {
            tbValues[member] = 0;
          }
          if (opponent in tiebreaker[member]) {
            tbValues[member] += parseFloat(tiebreaker[member][opponent]["wins"]);
          }
      }
    }
  }

  if (Object.keys(tbValues).length > 0) {
    if (complete == "Yes") {
      tableHeadings = ["#", "Player", "W%", "W", "L", "TB", "<img src='img/icons/tier.png'>", "<img src='img/icons/returning.png'>"];
      headingWidths = ["7%", "35%", "11%", "11%", "11%", "9%", "8%","8%"];
    } else {
      tableHeadings = ["#", "Player", "W%", "W", "L", "TB", "MP", "<img src='img/icons/tier.png'>"];
      headingWidths = ["6%", "35%", "11%", "11%", "11%", "8%", "11%","7%"];

    }
  }

  var headingRow = document.createElement("tr");
  headingRow.style.backgroundColor = "rgb(224, 224, 224)";
  for (let j = 0; j < headingWidths.length; j++) {
      var th = document.createElement("th");
      th.innerHTML = tableHeadings[j];
      th.style.width = headingWidths[j];
      if (tableHeadings[j].length > 10) {
        th.classList.add("header-icon");
      }
      headingRow.appendChild(th);
  }
  table.appendChild(headingRow);

  function isReturning(name){
    if (data[name]["drop"] == "Yes") {
      return "N";
    } else if (name in returning) {
      switch (returning[name]) {
        case "Y":
          return "Y";
        case "N":
          return "N";
        case "?":
          return "Err";
        default:
          return "Err";
      }
    }
    return "?"
  }

  var numPlayers = sortedRankedMembers.length;
  function tierOrMatches(playerData, cell) {
    if (complete == "Yes") {
      cell.innerHTML = playerData["next tier"];
      cell.style.textAlign = "center !important";
    } else {
      var games = playerData["games_nondrop"];
      var matches = numDrops + Math.floor(games/6);
      var base, remainder;
      if (playerData["drop"] == "Yes") {
        remainder = "";
        games = 6*(numPlayers - numDrops - 1);
        matches = numPlayers -1;
      } else if (games%6 == 0) {
        remainder = "";
      } else if (games%3 == 0) {
        remainder = " &#189;";
      } else if (games%2 == 0 && games/2 == 1) {
        remainder = " &#8532;"
      } else if (games%2 == 0 && games/2 == 0) {
        remainder = " &#8531;"
      } else if (games%6 == 1) {
        remainder = " &#8537;"
      } else if (games%6 == 5) {
        remainder = " &#8538;"
      }
      cell.innerHTML = `${matches}` + remainder;
      cell.style.backgroundColor =  matchGreyscaleColor(6*numDrops + games, 6*(numPlayers-1));
    }
  }

  for (var keypair of sortedRankedMembers) {
    var playerData = data[keypair[0]];
    var name = playerData["name"];
    var rowInfo = {
      "rank" : playerData["rank"],
      "name" : formatDbLink(name, "db-link", playerData["drop"]),
      "pct" : playerData["pct"],
      "wins" : playerData["wins"],
      "losses" : playerData["losses"],
      "tierOrMatches" : "",
      "returning" : isReturning(name)
    }

    var row = document.createElement("tr");
    for (var info in rowInfo) {
      var cell = document.createElement("td");
      cell.innerHTML = rowInfo[info];
      switch (info) {
        case "name":
          standingsColor(cell, tier, playerData["next tier"], playerData["name"]);
          break;
        case "pct" :
          cell.style.backgroundColor = playerData["color"];
          break;
        case "tierOrMatches":
          tierOrMatches(playerData, cell);
          if (Object.keys(tbValues).length > 0) {
            var tbCell = document.createElement("td");
            tbCell.style.color = "darkgray";
            if (name in tbValues) {
              tbCell.innerHTML = tbValues[name].toString();
            } else {
              tbCell.innerHTML = "0";
            }
            row.append(tbCell);
          }
          break;
      }
      row.append(cell);
    }
    table.append(row);
  }
  return table;
}

function genResults(results) {
  var table = document.createElement("table");
  table.classList.add('matches-table');
  table.style.display = "none";
}

function genMatches(data, drops, sorted) {
  console.log("Generating matches table...");

  var table = document.createElement("table");
  table.classList.add('matches-table');
  table.style.display = "none";

  var numMatches = {1: 0, 2: 1, 3: 3, 4: 6, 5: 10, 6: 15, 7: 21};
  var split = 1;//sorted.length >= 5 ? 2 : 1;
  var matches = numMatches[sorted.length];

  //var tableHeadings = ["Match", "Result", "Sessions", "Done?"];
  //var headingWidths = ["48%", "22%", "17%", "13%"];
  var tableHeadings = ["Match", "Result", "Fin?"];
  //var headingWidths = ["64%", "28%", "18%"];
  //tableHeadings = split == 2 ? tableHeadings.concat(tableHeadings) : tableHeadings;
  // headingWidths = split == 2 ? ["30%", "12%", "8%", "30%", "12%", "8%"] : headingWidths;
  var headingRow = document.createElement("tr");
  headingRow.style.backgroundColor = "rgb(224, 224, 224)";
  for (let j = 0; j < tableHeadings.length; j++) {
      var th = document.createElement("th");
      th.innerHTML = tableHeadings[j];
      //th.style.width = headingWidths[j];
      headingRow.appendChild(th);
  }
  table.appendChild(headingRow);

  var matches = [];
  for (var i=0; i < sorted.length; i++) {
    for (var j=i+1; j<sorted.length; j++){
      var player = sorted[i];
      var opponent = sorted[j];
      var match = `${player} vs. ${opponent}`;
      var result = "0 - 0";
      var sessions = 0;
      var completed = "No";
      if (opponent in data[player]) {
        result = `${data[player][opponent]["wins"].toString()} - ${data[player][opponent]["losses"].toString()}`;
        completed = data[player][opponent]["complete"];
        sessions = data[player][opponent]["sessions"];
      } else if (drops.includes(opponent) || drops.includes(player)) {
        match = `<s>${match}</s>`;
        completed = "N/A";
        sessions = "N/A";
      }
      matches.push({"match":match, "result":result, "completed":completed})
    }
  }

  var halfpoint = matches.length //split == 2 ?  Math.ceil(matches.length/2) : matches.length;

  for (var i=0; i < halfpoint; i++) {
    var row = document.createElement("tr");
    /*for (var s=0; s < split; s++){
      var startingIdx = s*(halfpoint-1)+i;
      console.log(startingIdx); */
    var info = matches[i];
    for (var key in info) {
      var cell = document.createElement("td");
      cell.innerHTML = info[key];
      row.append(cell);
    }
    table.append(row)
  }

  return table;
}

function genGrid(data, drops, sorted) {
  console.log("Generating grid...");
  var table = document.createElement("table");
  table.classList.add('grid-table');
  table.style.display = "none";


  var tableHeadings = [""]; //Placeholder for match completion rate.
  for (var m=0; m < sorted.length; m++) {
    tableHeadings[tableHeadings.length] = sorted[m];
  }
  var widths = {1: "50%", 2:"25%", 3:"20%", 4:"18%", 5:"14%", 6:"12%", 7:"10%"};
  //var firstWidths = {1: "50%", 2:"50%", 3:"40%", 4:"28%", 5:"30%", 6:"28%", 7:"30%"};
  var numPlayers = tableHeadings.length - 1;
  var headingRow = document.createElement("tr");
  for (let j = 0; j < tableHeadings.length; j++) {
      var th = document.createElement("th");
      if (j == 0) {
        th.innerHTML = tableHeadings[j];
        //th.style.width = firstWidths[numPlayers];
      } else {
        th.innerHTML = formatShortDbLink(tableHeadings[j], "db-link");
        //th.style.width = widths[numPlayers];
        //th.classList.add("verticalTableHeader");
      }
      headingRow.appendChild(th);
  }
  table.appendChild(headingRow);

  for (var m=0; m < sorted.length; m++) {
    var playerName = sorted[m];
    var row = document.createElement("tr");
    var playerCell = document.createElement("td");
    playerCell.innerHTML = formatDbLink(playerName, "db-link");
    row.append(playerCell);
    for (var opp=0; opp < sorted.length; opp++) {
      var opponent = sorted[opp];
      var cell = document.createElement("td");
      cell.innerHTML = "";
      cell.style.backgroundColor = "lightgrey";
      if (playerName == opponent) {
        cell.style.backgroundColor = "gray";
      } else if (opponent in data[playerName]){
        cell.innerHTML = data[playerName][opponent]["wins"];
        cell.style.backgroundColor = matchColor(data[playerName][opponent]["wins"], 6);
      } else if (drops.includes(opponent)) {
        //cell.classList.add("crossed");
      } else if (drops.includes(playerName)) {
        //cell.classList.add("crossed");
      } else {
      }
      row.append(cell);
    }
    table.appendChild(row);
  }
  return table;
}


function loadDivision(divisionDiv, division) {
  console.log(`Loading ${division} standings...`);

  // Get information
  var divisionData = divisions[division];
  var name = divisionData["name"];
  var tier = divisionData["tier"];
  var results = divisionData["results"];
  var standings = divisionData["members"];
  var players = divisionData["by_player"];
  var drops = divisionData["late drops"];
  var complete = divisionData["complete?"];
  //var tiebreaker = divisionData["tiebreaker"];

  // Compute sorted player list with drops last
  var sorted = [];
  for (var key in players) {
    sorted[sorted.length] = key;
  }
  sorted.sort(
    function(a, b) {
      if (drops.includes(a) && !(drops.includes(b))) {
        return 1;
      } else if (drops.includes(b)) {
        return -1;
      } else {
        if (a.toLowerCase() < b.toLowerCase()) return -1;
        if (a.toLowerCase() > b.toLowerCase()) return 1;
        return 0;
      }
    }
  );


  var standingsDiv = document.createElement("div");
  standingsDiv.setAttribute("id", `${division.toLowerCase()}-standings`);
  standingsDiv.classList.add(`standings`);
  standingsDiv.classList.add(`filterDiv`);
  standingsDiv.classList.add(`div${tier}`);
  divisionDiv.appendChild(standingsDiv);

  var header = genHeader(division, complete);
  var standingsTable = genStandings(standings, tier, players, drops.length, complete);
  var gridTable = genGrid(players, drops, sorted);
  var matchesTable = genMatches(players, drops, sorted);
  standingsDiv.appendChild(header);
  standingsDiv.appendChild(standingsTable);
  standingsDiv.appendChild(gridTable);
  standingsDiv.appendChild(matchesTable);

  // genGrid(players, standingsTable);

}

function singleDivision(division){
  console.log(`showing single division: ${division.toLowerCase()}-standings`);
  var divisionDiv = document.getElementById(`${division.toLowerCase()}-standings`);
  filterSelection("X"); //shows None
  w3AddClass(divisionDiv, "show");
}

function allDivisions(){
  var curTierIdx = 0;
  var curDiv = 1;
  var divisionDiv = document.getElementById("divisions");
  console.log("showing all divisions");
  var allDivisionsDiv = document.getElementById("all-divisions");
  allDivisionsDiv.style.display = "";
  console.log("hiding single division");
  var singleDivisionDiv = document.getElementById("single-division");
  singleDivisionDiv.style.display = "none";
  console.log(tiers);
  while (true) {
    if (curTierIdx == tiers.length) {
      break;
    }
    if (curDiv > tiers[curTierIdx][1]) {
      curDiv = 1;
      curTierIdx += 1;
    }
    if (curTierIdx == tiers.length) {
      break;
    }
    division = `${tiers[curTierIdx][0]}${curDiv}`;
    curDiv += 1;
    loadDivision(divisionDiv, division);

  }
  return;
}

function loadPage() {
  var division = getParam('div');
  var tier = getParam('tier');
  allDivisions();
  if (division.length > 0) {
    singleDivision(division.toUpperCase());
  } else if (tier.length == 1) {
    filterSelection("all");
  } else {
    filterSelection(`divA`);
  }
}

function getParam(paramName) {
  var urlParam = function(name, w){
      w = w || window;
      var rx = new RegExp('[\&|\?]'+name+'=([^\&\#]+)'),
          val = w.location.search.match(rx);
      return !val ? '':val[1];
  }
  var paramData = urlParam(paramName).replace(/%20/g, " ").trim();
  return paramData;
}

function filterSelection(c) {
  var x, i;
  x = document.getElementsByClassName("standings filterDiv");
  if (c == "all") c = "";
  for (i = 0; i < x.length; i++) {
    w3RemoveClass(x[i], "show");
    if (x[i].className.indexOf(c) > -1) {
      w3AddClass(x[i], "show");
    }
  }
}

function w3AddClass(element, name) {
  var i, arr1, arr2;
  arr1 = element.className.split(" ");
  arr2 = name.split(" ");
  for (i = 0; i < arr2.length; i++) {
    if (arr1.indexOf(arr2[i]) == -1) {element.className += " " + arr2[i];}
  }
}

function w3RemoveClass(element, name) {
  var i, arr1, arr2;
  arr1 = element.className.split(" ");
  arr2 = name.split(" ");
  for (i = 0; i < arr2.length; i++) {
    while (arr1.indexOf(arr2[i]) > -1) {
      arr1.splice(arr1.indexOf(arr2[i]), 1);
    }
  }
  element.className = arr1.join(" ");
}

// Add active class to the current button (highlight it)
var btnContainer = document.getElementById("myBtnContainer");
var btns = btnContainer.getElementsByClassName("btn");
for (var i = 0; i < btns.length; i++) {
  btns[i].addEventListener("click", function(){
    var current = document.getElementsByClassName("active");
    current[0].className = current[0].className.replace(" active", "");
    this.className += " active";
  });
}
</script>
